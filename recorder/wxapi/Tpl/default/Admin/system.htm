
<include file = "Common:admin_header" />

<!-- 中心数据区 -->
<div class="layui-tab layui-tab-brief">
  <div class="layui-body layui-tab-content site-demo">
    <div class="layui-tab-item layui-show">
      <div class="layui-main">
        <fieldset class="layui-elem-field layui-field-title">
          <legend><i class="fa fa-gears">&nbsp;&nbsp;网站系统设置</i></legend>
        </fieldset>
        <div class="layui-tab layui-tab-brief" lay-filter="tabSystem">
          <ul class="layui-tab-title">
            <li class="layui-this">&nbsp;&nbsp;常规系统设置&nbsp;&nbsp;</li>
            <li>&nbsp;&nbsp;行业名称设置&nbsp;&nbsp;</li>
          </ul>
          <div class="layui-tab-content">
            <div class="layui-tab-item layui-show js_normal_pane"></div>
            <div class="layui-tab-item js_name_pane"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// 获取网站地址...
var siteurl="{{:__APP__}}";
// 判断数字接口...
function isNumber(obj) {
  return obj === +obj
}
// 保存名称配置信息...
function doFormNameSet() {
  // 获取表单对象，监听事件...
  var form = layui.form;
  var $ = layui.jquery;
  form.on('submit(formNameSet)', function(data) {
    // 获取输入数据，调用接口立即存盘...
    var theNameTour = data.field.myNameTour;
    var theNameNav = data.field.myNameNav;
    var theNameFirst = data.field.myNameFirst;
    var theNameSecond = data.field.myNameSecond;
    var theNameThree = data.field.myNameThree;
    var theNameFour = data.field.myNameFour;
    var theNameFive = data.field.myNameFive;
    // 发送异步请求...
    $.ajaxSetup({ cache:false });
    layer.load(2);
    $.ajax({
      type: "post",
      async: true,
      url: siteurl+"/Admin/system",
      data: { operate: 'save', name_nav: theNameNav, name_first: theNameFirst,
              name_second: theNameSecond, name_three: theNameThree,
              name_four: theNameFour, name_five: theNameFive,
              name_tour: theNameTour },
      success: function(ajaxData) {
        layer.closeAll('loading');
        $("input[name='myNameTour']").val(theNameTour);
        $("input[name='myNameNav']").val(theNameNav);
        $("input[name='myNameFirst']").val(theNameFirst);
        $("input[name='myNameSecond']").val(theNameSecond);
        $("input[name='myNameThree']").val(theNameThree);
        $("input[name='myNameFour']").val(theNameFour);
        $("input[name='myNameFive']").val(theNameFive);
        layer.msg('恭喜！保存成功！', {icon: 1}, function(){
          location.reload(true);
        });
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        layer.closeAll('loading');
        layer.alert(textStatus+': '+XMLHttpRequest.status+','+errorThrown, {icon: 2});
      }
    });
    // 避免form页面跳转...
    return false;
  });
}
// 保存常规配置信息...
function doFormNormalSet() {
  // 获取表单对象，监听事件...
  var form = layui.form;
  var $ = layui.jquery;
  form.on('submit(formNormalSet)', function(data) {
    // 获取输入数据，调用接口立即存盘...
    var theSaveDays = data.field.mySaveDays;
    var thePhone = data.field.myWebPhone;
    var theTitle = data.field.myWebTitle;
    var theTrade = data.field.myWebTrade;
    var theSite = data.field.mySysSite;
    // 判断录像保留天数是否有效...
    if( isNaN(theSaveDays) || theSaveDays < 0 || theSaveDays > 360 ) {
      layer.msg('【录像保留】有效区间[0,360]，请更正！', {anim: 6,closeBtn: 1,time: 0, shade: 0.2}, function(){
        $("input[name='mySaveDays']").addClass('layui-form-danger');
        $("input[name='mySaveDays']").focus();
      });
      return false;
    }
    // 判断连接地址是否正确 => 先去掉左右的空格字符...
    theSite = theSite.replace(/(^\s*)|(\s*$)/g, "");
    var reg = /^([hH][tT][tT][pP]:\/\/|[hH][tT][tT][pP][sS]:\/\/)(.)+$/;
    if( !reg.test(theSite) ) {
      layer.msg('【官网地址】格式错误<br>必须是有效的http://或https://，请更正！', {anim: 6,closeBtn: 1,time: 0, shade: 0.2}, function(){
        $("input[name='mySysSite']").addClass('layui-form-danger');
        $("input[name='mySysSite']").focus();
      });
      return false;
    }
    // 发送异步请求 => 兼容IE8...
    $.ajaxSetup({ cache:false });
    layer.load(2);
    $.ajax({
      type: "post",
      async: true,
      url: siteurl+"/Admin/system",
      data: {operate: 'save', web_title: theTitle, web_phone: thePhone, sys_site: theSite, web_save_days: theSaveDays, web_trade: theTrade},
      success: function(ajaxData) {
        layer.closeAll('loading');
        $("input[name='mySaveDays']").val(theSaveDays);
        $("input[name='myWebPhone']").val(thePhone);
        $("input[name='myWebTitle']").val(theTitle);
        $("input[name='myWebTrade']").val(theTrade);
        $("input[name='mySysSite']").val(theSite);
        layer.msg('恭喜！保存成功！', {icon: 1}, function(){
          location.reload(true);
        });
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        layer.closeAll('loading');
        layer.alert(textStatus+': '+XMLHttpRequest.status+','+errorThrown, {icon: 2});
      }
    });
    // 避免form页面跳转...
    return false;
  });
}
// 响应卡片切换事件...
function doTabChange(inTabItem) {
  // 向服务器发送直播状态查看命令...
  var index = layer.load(2);
  var $ = layui.jquery;
  var strCommand, objCard;
  switch(inTabItem) {
    case 0: strCommand = "getNormalSet"; objCard = $('.js_normal_pane'); break;
    case 1: strCommand = "getNameSet"; objCard = $('.js_name_pane'); break;
  }
  // 异步获取通道信息...
  $.ajaxSetup({ cache:false });
  $.ajax({
    type: "get",
    async: true,
    url: siteurl+"/Admin/"+strCommand,
    success: function(ajaxData) {
      layer.closeAll('loading');
      objCard.html(ajaxData);
      switch( inTabItem ) {
        case 0:  doFormNormalSet(); break;
        case 1:  doFormNameSet(); break;
      }
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      layer.closeAll('loading');
      layer.alert(textStatus+': '+XMLHttpRequest.status+','+errorThrown, {icon: 2});
    }
  });
}
// 处理 layui 过程...
layui.use(['element','layer','form'], function(){
  // 获取表单对象，监听事件...
  var element = layui.element;
  var $ = layui.jquery;
  // 默认切换到中转服务器...
  doTabChange(0);
  // 监听Tab切换...
  element.on('tab(tabSystem)', function(data){
    doTabChange(data.index, this);
  });
});
</script>

<include file = "Common:admin_footer" />
