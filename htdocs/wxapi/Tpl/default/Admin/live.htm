
<include file = "Common:admin_header" />

<!-- 中心数据区 -->
<div class="layui-tab layui-tab-brief">
  <div class="layui-body layui-tab-content site-demo">
    <div class="layui-tab-item layui-show">
      <div class="layui-main">
        <fieldset class="layui-elem-field layui-field-title">
          <legend><i class="fa fa-video-camera">&nbsp;直播管理</i></legend>
        </fieldset>
        <span class="layui-breadcrumb">
          <a><cite>直播通道</cite></a>
          <a><cite>共 {{$my_total_num}} 条记录</cite></a>
        </span>
        <div style="margin-top:10px;width:100%">
          <table class="layui-table">
            <colgroup>
              <col width="60">
              <eq name='my_web_type' value='0'>
              <col width="80">
              <col width="80">
              <else/>
              <col width="80">
              </eq>
              <col width="80">
              <col width="80">
              <col width="80">
              <col width="100">
              <col width="100">
            </colgroup>
            <thead>
              <tr>
                <th>状态</th>
                <eq name='my_web_type' value='0'>
                <th>学校</th>
                <th>年级</th>
                <th>班级</th>
                <else/>
                <th>播放次数</th>
                <th>名称</th>
                </eq>
                <th>标识</th>
                <th>类型</th>
                <th>数据源</th>
                <th>操作</th>
              </tr> 
            </thead>
            <tbody class="js_live"></tbody>
          </table>
          <div style="float:left;" id="myPage"></div>
        </div>        
      </div>
    </div>
  </div>
</div>

<script>
//
// 获取网站地址...
var siteurl="{{:__APP__}}";
//
// 点击某一行事件...
function doTrClick(inLiveID, inGatherID,objTr) {
  // 向服务器发送直播状态查看命令...
  var nWebType = {{$my_web_type}};
  var index = layer.load(2);
  var $ = layui.jquery;
  // 先将背景色进行修改...
  $(objTr).css('background-color', '#87CEFA').siblings().css('background-color', '#FFFFFF');
  // 异步获取通道信息...
  $.ajaxSetup({ cache:false });
  $.ajax({
    type: "get",
    async: true,
    url: siteurl+"/Admin/getLiveStatus/camera_id/"+inLiveID,
    success: function(ajaxData) {
      layer.closeAll('loading');
      layer.open({
        type: 1, //0(dialog), 1(page), 2(iframe), 3(loading), 4(tips)
        closeBtn: 1,
        fixed: true,
        shadeClose: false,
        area: ['500px', '450px'],
        title: "<i class='fa fa-video-camera'>&nbsp;&nbsp;</i>编辑 - 直播通道",
        content: ajaxData,
        success: function() {
          var form = layui.form;
          form.render();
          // 这里必须调用render才能显示select...
          form.on('submit(formCamera)', function(data) {
            var theCameraName = "", theGradeName = "", theCameraGrade = 0;
            theCameraName = data.field.myCameraName;
            // 云录播模式下的处理过程...
            if( nWebType <= 0 ) {
              theCameraGrade = data.field.myCameraGrade;
              theGradeName = $("select[name='myCameraGrade']").find("option:selected").text();
              // 判断输入数据的有效性...
              if( theCameraGrade <= 0 ) {
                layer.msg('【所在年级】不能为空，请更正！', {icon: 2});
                return false;
              }
            }
            // 发送摄像头数据，通过ajax异步发送存盘命令...
            // 传递 gather_id 和 grade_name 的目的是为了转发摄像头名称给采集端...
            layer.load(2);
            $.ajax({
              type: "post",
              async: true,
              url: siteurl+"/Admin/saveCamera",
              data: {camera_id: inLiveID, gather_id: inGatherID, grade_id: theCameraGrade, grade_name: theGradeName, camera_name: theCameraName},
              success: function(ajaxData) {
                layer.closeAll('loading');
                layer.msg('恭喜！保存成功！', {icon: 1,time: 1000}, function() {
                  //location.href = siteurl+"/Admin/live";
                  if( nWebType > 0 ) {
                    // 云监控模式...
                    $(objTr).children('td').eq(2).text(theCameraName);
                  } else {
                    // 云录播模式...
                    $(objTr).children('td').eq(2).text(theGradeName);
                    $(objTr).children('td').eq(3).text(theCameraName);
                  }
                  layer.closeAll('page');
                });
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                layer.closeAll('loading');
                layer.alert(textStatus+': '+XMLHttpRequest.status+','+errorThrown, {icon: 2});
              }
            });
            // 否则，form会自动跳转...
            return false;
          });
          // 点击取消操作...
          $('.js_form_close').unbind("click").click( function() {
            layer.closeAll('page');
          });
        }
      });
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      layer.closeAll('loading');
      layer.alert(textStatus+': '+XMLHttpRequest.status+','+errorThrown, {icon: 2});
    }
  });
}
//
// 点击操作通道按钮 => 让服务器去判断和处理...
function doCamera(inCameraID, objBtn)
{
  // 需要兼容IE8的访问...
  stopPropagation(event);
  var $ = layui.jquery;
  var index = layer.load(2);
  $.ajaxSetup({ cache:false });
  $.ajax({
    type: "get",
    async: true,
    url: siteurl+"/Admin/doCamera/camera_id/"+inCameraID,
    success: function(ajaxData) {
      layer.closeAll('loading');
      // 解析服务器传递过来的json数据包...
      var arrJson = $.parseJSON(ajaxData);
      if( arrJson.err_code > 0 ) {
        var strErr = ((arrJson.err_cmd==15) ? "启动通道失败" : "停止通道失败");
        layer.msg(strErr + "<br>" + arrJson.err_msg, {anim: 6});
        return;
      }
      // 转发命令成功，将按钮置灰...
      $(objBtn).addClass('layui-btn-disabled');
      // 等待3~5秒之后，查询通道状态...
      layer.msg('处理中，请稍等...', { icon: 16, shade: 0.2} );
      setTimeout(function () {
        doGetCameraStatus(inCameraID, objBtn, arrJson.err_cmd);
      }, 3500);
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      layer.closeAll('loading');
      layer.alert(textStatus+': '+XMLHttpRequest.status+','+errorThrown, {icon: 2});
    }
  });
}
//
// 超时时钟去获取通道状态...
function doGetCameraStatus(inCameraID, objBtn, inCmd)
{
  var $ = layui.jquery;
  $.ajaxSetup({ cache:false });
  $.ajax({
    type: "get",
    async: true,
    url: siteurl+"/Admin/getCameraStatus/camera_id/"+inCameraID,
    success: function(ajaxData) {
      // 先关闭等待对话框...
      layer.closeAll('loading');
      var theBTN = $(objBtn);
      var theTD = $(objBtn).parent();
      // 设置各个按钮样式状态...
      theBTN.removeClass('layui-btn-disabled');
      if( ajaxData > 0 ) {
        theBTN.addClass('layui-btn-danger');
        theBTN.html('<i class="fa fa-stop-circle-o">&nbsp;停止</i>');
        theTD.siblings().eq(0).html('<i class="fa fa-tv fa-run">&nbsp;运行中</i>');
        // 如果是停止命令又回到停止状态，说明停止失败...
        if(inCmd == 16) { layer.msg("停止通道失败！", {anim: 6}); }
      } else {
        theBTN.removeClass('layui-btn-danger');
        theBTN.html('<i class="fa fa-play-circle-o">&nbsp;启动</i>');
        theTD.siblings().eq(0).html('<i class="fa fa-power-off fa-wait">&nbsp;等待中</i>');
        // 如果是启动命令又回到启动状态，说明启动失败...
        if( inCmd == 15 ) { layer.msg("启动通道失败！", {anim: 6}); }
      }
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      layer.closeAll('loading');
      layer.alert(textStatus+': '+XMLHttpRequest.status+','+errorThrown, {icon: 2});
    }
  });
}
//
// 配置录像课程表...
function doCourse(inCameraID, inGatherID)
{
  // 需要兼容IE8的访问...
  stopPropagation(event);
  location.href = siteurl+"/Admin/course/camera_id/"+inCameraID+"/gather_id/"+inGatherID+"/type/live";  
}
//
// 处理 layui 过程...
layui.use(['element','laypage','layer','form'], function(){
  var laypage = layui.laypage;
  var layer = layui.layer;
  var $ = layui.jquery;
  laypage.render({
    count: {{$my_total_num}}, // 总记录数...
    elem: 'myPage',           // 分页对象...
    groups: 5,                // 连续显示分页数
    jump: function(obj, first) {
      // 向服务器发送分页命令...
      var index = layer.load(2);
      $.ajaxSetup({ cache:false });
      $.ajax({
        type: "get",
        async: true,
        url: siteurl+"/Admin/pageLive/p/"+obj.curr,
        success: function(ajaxData) {
          layer.closeAll('loading');
          $('.js_live').html(ajaxData);
          $('tbody tr').css('cursor','pointer');
          //$('tr').css('height','50px');
          //$('tr').click(function(){
          //alert(this);//});
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          layer.closeAll('loading');
          layer.alert(textStatus+': '+XMLHttpRequest.status+','+errorThrown, {icon: 2});
        }
      });    
    }
  });
});

</script>

<include file = "Common:admin_footer" />
